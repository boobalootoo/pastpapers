<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interactive PDF Annotator</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
        }
        #pdf-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin: auto;
        }
        canvas {
            display: block;
            width: 100%;
        }
        #overlay {
            position: absolute;
            left: 0;
            top: 0;
            cursor: crosshair;
        }
        #tools {
            text-align: center;
            margin: 10px;
        }
        #tools button, #tools select, #tools input[type=color], #tools input[type=range] {
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <div id="tools">
        <label>Choose PDF:
            <select id="pdfSelector">
                <option value="Computational thinking, algorithms and programming 2018.pdf">CTAP 2018</option>
            </select>
        </label>
        <button onclick="prevPage()">Previous</button>
        <span id="pageInfo">Page 1</span>
        <button onclick="nextPage()">Next</button>
        |
        <label>Color:
            <input type="color" id="penColor" value="#ff0000">
        </label>
        <label>Thickness:
            <input type="range" id="penWidth" min="1" max="10" value="2">
        </label>
        <button onclick="undo()">Undo</button>
        <button onclick="redo()">Redo</button>
        <button onclick="deleteAllEdits()">Delete All Edits</button>
        <button onclick="downloadFullPDF()">Download Paper</button>
    </div>

    <div id="pdf-container">
        <canvas id="pdf-canvas"></canvas>
        <canvas id="overlay"></canvas>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        const urlBase = "https://boobalootoo.github.io/pastpapers/";
        const pdfCanvas = document.getElementById('pdf-canvas');
        const overlay = document.getElementById('overlay');
        const ctx = overlay.getContext('2d');
        const pageInfo = document.getElementById('pageInfo');

        let pdfDoc = null;
        let currentPage = 1;
        let totalPages = 0;
        let scale = 1.5;
        let currentPDF = "";

        let isDrawing = false;
        let lastX = 0, lastY = 0;

        let history = [];
        let redoStack = [];

        function saveState() {
            history.push(ctx.getImageData(0, 0, overlay.width, overlay.height));
            redoStack = [];
        }

        function undo() {
            if (history.length > 0) {
                redoStack.push(ctx.getImageData(0, 0, overlay.width, overlay.height));
                const imageData = history.pop();
                ctx.putImageData(imageData, 0, 0);
                saveDrawing();
            }
        }

        function redo() {
            if (redoStack.length > 0) {
                history.push(ctx.getImageData(0, 0, overlay.width, overlay.height));
                const imageData = redoStack.pop();
                ctx.putImageData(imageData, 0, 0);
                saveDrawing();
            }
        }

        function saveDrawing() {
            const dataURL = overlay.toDataURL();
            localStorage.setItem(`${currentPDF}-page-${currentPage}`, dataURL);
        }

        function loadDrawing() {
            const saved = localStorage.getItem(`${currentPDF}-page-${currentPage}`);
            ctx.clearRect(0, 0, overlay.width, overlay.height);
            if (saved) {
                const img = new Image();
                img.onload = () => ctx.drawImage(img, 0, 0);
                img.src = saved;
            }
            history = [];
            redoStack = [];
        }

        overlay.addEventListener('mousedown', startDraw);
        overlay.addEventListener('mousemove', draw);
        overlay.addEventListener('mouseup', stopDraw);
        overlay.addEventListener('mouseout', stopDraw);

        overlay.addEventListener('touchstart', e => startDraw(e.touches[0]));
        overlay.addEventListener('touchmove', e => {
            draw(e.touches[0]);
            e.preventDefault();
        }, { passive: false });
        overlay.addEventListener('touchend', stopDraw);

        function startDraw(e) {
            isDrawing = true;
            const rect = overlay.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
            saveState();
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = overlay.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.strokeStyle = document.getElementById("penColor").value;
            ctx.lineWidth = document.getElementById("penWidth").value;
            ctx.lineCap = "round";
            ctx.stroke();

            lastX = x;
            lastY = y;
        }

        function stopDraw() {
            if (isDrawing) {
                isDrawing = false;
                saveDrawing();
            }
        }

        function setupOverlay() {
            overlay.width = pdfCanvas.width;
            overlay.height = pdfCanvas.height;
        }

        function deleteAllEdits() {
            if (confirm("Are you sure you want to delete all edits?")) {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith(currentPDF + "-page-")) {
                        localStorage.removeItem(key);
                    }
                });
                location.reload();
            }
        }

        async function loadPDF(url) {
            currentPDF = decodeURIComponent(url.split("/").pop());
            pdfDoc = await pdfjsLib.getDocument(url).promise;
            totalPages = pdfDoc.numPages;
            currentPage = 1;
            renderPage(currentPage);
        }

        async function renderPage(num) {
            const page = await pdfDoc.getPage(num);
            const viewport = page.getViewport({ scale });
            const context = pdfCanvas.getContext('2d');

            pdfCanvas.width = viewport.width;
            pdfCanvas.height = viewport.height;

            overlay.width = viewport.width;
            overlay.height = viewport.height;
            ctx.clearRect(0, 0, overlay.width, overlay.height);

            const renderContext = {
                canvasContext: context,
                viewport
            };
            await page.render(renderContext).promise;

            setupOverlay();
            loadDrawing();
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                renderPage(currentPage);
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderPage(currentPage);
            }
        }

        document.getElementById('pdfSelector').addEventListener('change', function () {
            const selectedFile = this.value;
            loadPDF(urlBase + encodeURIComponent(selectedFile));
        });

        async function downloadFullPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            for (let i = 1; i <= totalPages; i++) {
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale });
                const renderCanvas = document.createElement("canvas");
                const renderCtx = renderCanvas.getContext("2d");
                renderCanvas.width = viewport.width;
                renderCanvas.height = viewport.height;

                await page.render({ canvasContext: renderCtx, viewport }).promise;

                const overlayImg = localStorage.getItem(`${currentPDF}-page-${i}`);
                if (overlayImg) {
                    const tempCtx = renderCanvas.getContext("2d");
                    const img = new Image();
                    img.src = overlayImg;
                    await new Promise(resolve => {
                        img.onload = () => {
                            tempCtx.drawImage(img, 0, 0);
                            resolve();
                        };
                    });
                }

                const imgData = renderCanvas.toDataURL("image/png");
                if (i > 1) doc.addPage();
                doc.addImage(imgData, "PNG", 10, 10, 190, 0);
            }

            doc.save(`${currentPDF}_annotated.pdf`);
        }

        // Load initial PDF
        loadPDF(urlBase + encodeURIComponent(document.getElementById('pdfSelector').value));
    </script>
</body>
</html>
